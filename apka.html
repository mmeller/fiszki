<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplikacja do nauki słówek</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Stylowanie tabeli */
      .custom-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        border-radius: 0.5rem;
        overflow: hidden; /* Zaokrąglenie rogów tabeli */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .custom-table thead th {
        background-color: #f7fafc; /* Kolor nagłówka */
        color: #4a5568; /* Kolor tekstu w nagłówku */
        padding: 0.75rem;
        text-align: left;
        font-size: 0.8rem;
        font-weight: 600; /* Pogrubienie tekstu w nagłówku */
        border-bottom: 2px solid #edf2f7; /* Linia oddzielająca nagłówek */
      }

      .custom-table tbody tr:nth-child(odd) {
        background-color: #ffffff; /* Kolor nieparzystych wierszy */
      }

      .custom-table tbody tr:nth-child(even) {
        background-color: #f7fafc; /* Kolor parzystych wierszy */
      }

      .custom-table tbody tr:hover {
        background-color: #ebf4ff; /* Kolor tła przy najechaniu myszą */
      }

      .custom-table td {
        padding: 0.75rem;
        color: #2d3748; /* Kolor tekstu w komórkach */
        font-size: 0.9rem;
        border-bottom: 1px solid #edf2f7; /* Linia oddzielająca wiersze */
      }

      .custom-table td:last-child {
        text-align: center; /* Wycentrowanie zawartości ostatniej kolumny */
      }

      .custom-table-actions {
        display: flex;
        justify-content: center; /* Wycentrowanie ikon akcji */
        gap: 0.5rem; /* Odstęp między ikonami */
      }

      .custom-icon-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.25rem;
        border-radius: 0.375rem; /* Zaokrąglenie rogów ikon */
        cursor: pointer;
        transition: background-color 0.2s ease; /* Płynne przejście koloru tła */
      }

      .custom-icon-button:hover {
        background-color: rgba(
          0,
          0,
          0,
          0.1
        ); /* Delikatne szare tło przy najechaniu */
      }

      .custom-icon {
        width: 1.25rem; /* Rozmiar ikon */
        height: 1.25rem;
        color: #4a5568; /* Kolor ikon */
      }

      .custom-checkbox {
        margin-right: 0.5rem; /* Odstęp między checkboxem a tekstem */
      }

      .input-error {
        border-color: #e53e3e !important;
        color: #e53e3e !important;
      }

      .error-message {
        color: #e53e3e;
        font-size: 0.875rem;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans antialiased">
    <div class="mx-auto max-w-4xl p-4">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
        Aplikacja do nauki słówek
      </h1>

      <div class="mb-6">
        <ul class="flex space-x-4 border-b border-gray-200">
          <li class="flex-1">
            <a
              href="#slowniczek"
              class="block py-2 px-4 text-center text-gray-700 hover:text-blue-600 hover:border-blue-500 border-b-2 font-medium transition-colors duration-300"
              >Słowniczek</a
            >
          </li>
          <li class="flex-1">
            <a
              href="#ucz-sie"
              class="block py-2 px-4 text-center text-gray-700 hover:text-blue-600 hover:border-blue-500 border-b-2 font-medium transition-colors duration-300"
              >Ucz się</a
            >
          </li>
          <li class="flex-1">
            <a
              href="#znam-juz"
              class="block py-2 px-4 text-center text-gray-700 hover:text-blue-600 hover:border-blue-500 border-b-2 font-medium transition-colors duration-300"
              >Znam już</a
            >
          </li>
          <li class="flex-1">
            <a
              href="#test"
              class="block py-2 px-4 text-center text-gray-700 hover:text-blue-600 hover:border-blue-500 border-b-2 font-medium transition-colors duration-300"
              >Test</a
            >
          </li>
        </ul>
      </div>

      <div id="slowniczek" class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Słowniczek</h2>

        <div class="mb-4 flex flex-col sm:flex-row gap-4">
          <input
            type="text"
            id="search-input"
            placeholder="Szukaj słówka..."
            class="w-full sm:w-auto rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"
          />
          <input
            type="text"
            id="original-input"
            placeholder="Słowo oryginalne"
            class="w-full sm:w-auto rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"
          />
          <input
            type="text"
            id="translation-input"
            placeholder="Tłumaczenie"
            class="w-full sm:w-auto rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"
          />
          <button
            id="add-word-button"
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
          >
            Dodaj słówko
          </button>
        </div>
        <div id="error-message-container" class="mb-4"></div>

        <button
          id="import-csv-button"
          class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline mb-4"
        >
          Importuj z CSV
        </button>
        <input type="file" id="csv-file-input" accept=".csv" class="hidden" />

        <div class="flex justify-start mb-4">
          <button
            id="add-to-learn-selected-button"
            class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
          >
            Dodaj do Ucz się
          </button>
        </div>

        <table class="custom-table">
          <thead>
            <tr>
              <th></th>
              <th>Słowo oryginalne</th>
              <th>Tłumaczenie</th>
              <th>Edytuj</th>
              <th>Usuń</th>
              <th>Do Ucz się</th>
            </tr>
          </thead>
          <tbody id="word-list">
            <tr>
              <td colspan="6" class="text-center text-gray-500 py-4">
                Brak słówek do wyświetlenia.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="ucz-sie" class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ucz się</h2>

        <div
          id="flashcard-container"
          class="bg-white rounded-md shadow-md p-6 text-center mb-4"
        >
          <p id="flashcard-text" class="text-xl text-gray-800">
            Kliknij "Następne" aby rozpocząć naukę
          </p>
        </div>

        <div class="flex justify-center gap-4 mb-4">
          <button
            id="previous-button"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
            disabled
          >
            Poprzednie
          </button>
          <button
            id="next-button"
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
          >
            Następne
          </button>
          <button
            id="mark-learned-button"
            class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
          >
            Umiem
          </button>
        </div>

        <div class="flex justify-center gap-4 mb-4">
          <label for="translation-direction" class="text-gray-700 font-medium"
            >Rodzaj tłumaczenia:</label
          >
          <select
            id="translation-direction"
            class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"
          >
            <option value="original-to-translated">
              Oryginalny -> Tłumaczenie
            </option>
            <option value="translated-to-original">
              Tłumaczenie -> Oryginalny
            </option>
          </select>
          <button
            id="shuffle-button"
            class="bg-yellow-500 hover:bg-yellow-700 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
          >
            Losuj kolejność
          </button>
        </div>
      </div>

      <div id="znam-juz" class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Znam już</h2>

        <div class="flex justify-start mb-4">
          <button
            id="remove-learned-selected-button"
            class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
          >
            Usuń zaznaczone
          </button>
        </div>

        <table class="custom-table">
          <thead>
            <tr>
              <th></th>
              <th>Słowo oryginalne</th>
              <th>Tłumaczenie</th>
              <th>Oznacz jako nieznane</th>
            </tr>
          </thead>
          <tbody id="learned-word-list">
            <tr>
              <td colspan="4" class="text-center text-gray-500 py-4">
                Brak słówek w sekcji "Znam już".
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="test" class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Test</h2>

        <div class="mb-4">
          <label for="test-scope" class="text-gray-700 font-medium mr-2"
            >Zakres testu:</label
          >
          <select
            id="test-scope"
            class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"
          >
            <option value="all">Wszystkie słówka</option>
            <option value="learned">Tylko "Znam już"</option>
            <option value="random">Losowe 10 słówek</option>
          </select>
        </div>

        <div class="mb-4">
          <label
            for="test-translation-direction"
            class="text-gray-700 font-medium mr-2"
            >Rodzaj tłumaczenia:</label
          >
          <select
            id="test-translation-direction"
            class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"
          >
            <option value="translated-to-original">
              Tłumaczenie -> Oryginalny
            </option>
            <option value="original-to-translated">
              Oryginalny -> Tłumaczenie
            </option>
          </select>
        </div>

        <div class="mb-4">
          <label for="test-type" class="text-gray-700 font-medium mr-2"
            >Typ testu:</label
          >
          <select
            id="test-type"
            class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"
          >
            <option value="text-input">
              Pytanie o tłumaczenie (wpisz odpowiedź)
            </option>
            <option value="multiple-choice">4 odpowiedzi do wyboru</option>
          </select>
        </div>

        <button
          id="start-test-button"
          class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline mb-4"
        >
          Rozpocznij test
        </button>

        <div
          id="test-container"
          class="bg-white rounded-md shadow-md p-6 text-center mb-4"
          style="display: none"
        >
          <p id="test-question" class="text-xl text-gray-800 mb-4"></p>
          <div id="test-input-container" class="mb-4" style="display: none">
            <input
              type="text"
              id="test-answer-input"
              placeholder="Twoja odpowiedź"
              class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 w-full sm:w-auto"
            />
          </div>
          <div
            id="test-options-container"
            class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"
            style="display: none"
          >
            <button
              id="test-option-1"
              class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
            ></button>
            <button
              id="test-option-2"
              class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
            ></button>
            <button
              id="test-option-3"
              class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
            ></button>
            <button
              id="test-option-4"
              class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
            ></button>
          </div>
          <button
            id="submit-test-answer-button"
            class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
          >
            Sprawdź odpowiedź
          </button>
          <p id="test-feedback" class="mt-4 font-semibold"></p>
        </div>

        <div
          id="test-results-container"
          class="bg-white rounded-md shadow-md p-6 text-center"
          style="display: none"
        >
          <h3 class="text-xl font-semibold text-gray-800 mb-2">Wyniki testu</h3>
          <p id="test-results-text" class="text-lg text-gray-700 mb-4"></p>
          <button
            id="restart-test-button"
            class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:shadow-outline"
          >
            Zakończ test
          </button>
        </div>
      </div>
    </div>

    <script>
      let words = [];
      let learnedWords = [];
      let currentFlashcardIndex = 0;
      let selectedWordsForLearning = [];
      let testQuestions = [];
      let currentTestQuestionIndex = 0;
      let correctAnswers = 0;
      let currentTestType = "text-input"; // Domyślny typ testu
      let currentTestScope = "all";
      let currentTestTranslationDirection = "translated-to-original";

      // Funkcje pomocnicze
      /**
       * Wyświetla komunikat o błędzie.
       * @param {string} message - Treść komunikatu.
       * @param {string} inputId - ID elementu input, z którym jest związany błąd.
       */
      function displayErrorMessage(message, inputId = null) {
        const errorContainer = document.getElementById(
          "error-message-container"
        );
        errorContainer.innerHTML = ""; // Wyczyść poprzednie komunikaty
        const errorDiv = document.createElement("div");
        errorDiv.className =
          "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative";
        errorDiv.role = "alert";
        const errorSpan = document.createElement("span");
        errorSpan.className = "block sm:inline";
        errorSpan.textContent = message;
        errorDiv.appendChild(errorSpan);
        errorContainer.appendChild(errorDiv);

        if (inputId) {
          const inputElement = document.getElementById(inputId);
          inputElement.classList.add("input-error");
          inputElement.setAttribute("aria-invalid", "true");
        }
      }

      /**
       * Czyści komunikat o błędzie i styluje input jako poprawny.
       * @param {string} inputId - ID elementu input do wyczyszczenia.
       */
      function clearErrorMessage(inputId) {
        const errorContainer = document.getElementById(
          "error-message-container"
        );
        errorContainer.innerHTML = ""; // Wyczyść komunikaty
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
          inputElement.classList.remove("input-error");
          inputElement.removeAttribute("aria-invalid");
        }
      }

      /**
       * Dodaje słówko do tablicy i odświeża widok listy słówek.
       */
      function addWord() {
        const originalInput = document.getElementById("original-input");
        const translationInput = document.getElementById("translation-input");
        const original = originalInput.value.trim();
        const translation = translationInput.value.trim();

        clearErrorMessage("original-input");
        clearErrorMessage("translation-input");

        if (!original) {
          displayErrorMessage(
            "Proszę wpisać słowo oryginalne.",
            "original-input"
          );
          return;
        }
        if (!translation) {
          displayErrorMessage(
            "Proszę wpisać tłumaczenie.",
            "translation-input"
          );
          return;
        }

        const newWord = { original, translation, learned: false };
        words.push(newWord);
        displayWords();
        originalInput.value = "";
        translationInput.value = "";
      }

      /**
       * Funkcja do importu słówek z pliku CSV
       */
      function importCsv(file) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const csvContent = event.target.result;
          const lines = csvContent.split("\n");
          let newWords = [];
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line === "") continue;
            const parts = line.split("|").map((p) => p.trim());
            if (parts.length === 2) {
              const original = parts[0];
              const translation = parts[1];
              if (original && translation) {
                newWords.push({ original, translation, learned: false });
              }
            } else {
              console.warn(`Skipping invalid line: ${line}`);
            }
          }
          words = words.concat(newWords); // Dodaj nowe słówka do istniejących
          displayWords();
        };
        reader.onerror = function () {
          displayErrorMessage("Błąd odczytu pliku CSV.");
        };
        reader.readAsText(file);
      }

      /**
       * Wyświetla listę słówek w tabeli.
       */
      function displayWords() {
        const wordList = document.getElementById("word-list");
        wordList.innerHTML = "";
        if (words.length === 0) {
          wordList.innerHTML =
            '<tr><td colspan="6" class="text-center text-gray-500 py-4">Brak słówek do wyświetlenia.</td></tr>';
          return;
        }

        words.forEach((word, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td><input type="checkbox" class="custom-checkbox" data-index="${index}"></td>
                    <td>${word.original}</td>
                    <td>${word.translation}</td>
                    <td><button class="edit-button custom-icon-button" data-index="${index}"><img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/pencil.svg" class="custom-icon" /></button></td>
                    <td><button class="delete-button custom-icon-button" data-index="${index}"><img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/trash-2.svg" class="custom-icon" /></button></td>
                    <td><button class="add-to-learn-button custom-icon-button" data-index="${index}"><img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/arrow-right-circle.svg" class="custom-icon" /></button></td>
                `;
          wordList.appendChild(row);
        });

        // Obsługa zdarzeń dla przycisków
        document.querySelectorAll(".edit-button").forEach((button) => {
          button.addEventListener("click", () =>
            editWord(parseInt(button.dataset.index))
          );
        });
        document.querySelectorAll(".delete-button").forEach((button) => {
          button.addEventListener("click", () =>
            deleteWord(parseInt(button.dataset.index))
          );
        });
        document.querySelectorAll(".add-to-learn-button").forEach((button) => {
          button.addEventListener("click", () =>
            addWordToLearn(parseInt(button.dataset.index))
          );
        });
      }

      /**
       * Edytuje istniejące słówko.
       * @param {number} index - Indeks słówka do edycji.
       */
      function editWord(index) {
        const word = words[index];
        const originalInput = document.getElementById("original-input");
        const translationInput = document.getElementById("translation-input");
        originalInput.value = word.original;
        translationInput.value = word.translation;

        // Usuń słówko z listy, aby po dodaniu edytowanego słówka nie było duplikatu
        words.splice(index, 1);
        displayWords();

        // Ustaw focus na pole input słowa oryginalnego
        originalInput.focus();
      }

      /**
       * Usuwa słówko z listy.
       * @param {number} index - Indeks słówka do usunięcia.
       */
      function deleteWord(index) {
        words.splice(index, 1);
        displayWords();
      }

      /**
       * Dodaje zaznaczone słówka do listy "Ucz się".
       */
      function addSelectedWordsToLearn() {
        selectedWordsForLearning = []; //Resetuj zaznaczone słówka
        const checkboxes = document.querySelectorAll(".custom-checkbox");
        checkboxes.forEach((checkbox) => {
          if (checkbox.checked) {
            const index = parseInt(checkbox.dataset.index);
            selectedWordsForLearning.push(words[index]);
          }
        });
        if (selectedWordsForLearning.length === 0) {
          alert('Zaznacz słówka, które chcesz dodać do listy "Ucz się".');
          return;
        }

        // Dodaj tylko te słówka, które nie są jeszcze w learnedWords
        selectedWordsForLearning.forEach((word) => {
          const isLearned = learnedWords.some(
            (learnedWord) => learnedWord.original === word.original
          );
          if (!isLearned) {
            // Sprawdź czy słowo już istnieje w words
            const wordExists = words.some((w) => w.original === word.original);
            if (wordExists) {
              words.forEach((w) => {
                if (w.original === word.original) {
                  w.learned = false;
                }
              });
            }
          }
        });

        currentFlashcardIndex = 0; // Resetuj indeks fiszki
        displayFlashcard();
        alert(
          `Dodano ${selectedWordsForLearning.length} słówek do listy "Ucz się".`
        );
      }

      /**
       * Wyświetla losowe słowo z listy "Ucz się" jako fiszkę.
       */
      function displayFlashcard() {
        const flashcardText = document.getElementById("flashcard-text");
        if (selectedWordsForLearning.length === 0) {
          flashcardText.textContent =
            "Brak słówek do nauki. Dodaj słówka do zakładki 'Ucz się'.";
          document.getElementById("previous-button").disabled = true;
          document.getElementById("next-button").disabled = true;
          document.getElementById("mark-learned-button").disabled = true;
          return;
        }
        const translationDirection = document.getElementById(
          "translation-direction"
        ).value;
        const currentWord = selectedWordsForLearning[currentFlashcardIndex];
        let frontText, backText;

        if (translationDirection === "original-to-translated") {
          frontText = currentWord.original;
          backText = currentWord.translation;
        } else {
          frontText = currentWord.translation;
          backText = currentWord.original;
        }

        flashcardText.textContent = frontText;
        flashcardText.dataset.front = frontText; // Przechowujemy front
        flashcardText.dataset.back = backText; // i tył fiszki
        document.getElementById("previous-button").disabled =
          currentFlashcardIndex === 0;
        document.getElementById("next-button").disabled =
          currentFlashcardIndex >= selectedWordsForLearning.length - 1;
        document.getElementById("mark-learned-button").disabled = false;
      }

      /**
       * Przechodzi do poprzedniej fiszki.
       */
      function showPreviousFlashcard() {
        if (currentFlashcardIndex > 0) {
          currentFlashcardIndex--;
          displayFlashcard();
        }
      }

      /**
       * Przechodzi do następnej fiszki.
       */
      function showNextFlashcard() {
        if (currentFlashcardIndex < selectedWordsForLearning.length - 1) {
          currentFlashcardIndex++;
          displayFlashcard();
        }
      }

      /**
       * Oznacza słówko jako nauczone i przenosi do listy "Znam już".
       */
      function markWordAsLearned() {
        if (selectedWordsForLearning.length === 0) return;
        const currentWord = selectedWordsForLearning[currentFlashcardIndex];
        const isLearned = learnedWords.some(
          (word) => word.original === currentWord.original
        );
        if (!isLearned) {
          learnedWords.push(currentWord);
        }

        // Usuń z selectedWordsForLearning
        selectedWordsForLearning.splice(currentFlashcardIndex, 1);
        if (currentFlashcardIndex >= selectedWordsForLearning.length) {
          currentFlashcardIndex = selectedWordsForLearning.length - 1;
        }

        displayFlashcard(); // Wyświetl kolejną fiszkę
        displayLearnedWords();
        if (selectedWordsForLearning.length === 0) {
          const flashcardText = document.getElementById("flashcard-text");
          flashcardText.textContent =
            "Brak słówek do nauki. Dodaj słówka do zakładki 'Ucz się'.";
          document.getElementById("previous-button").disabled = true;
          document.getElementById("next-button").disabled = true;
          document.getElementById("mark-learned-button").disabled = true;
        }
      }

      /**
       * Wyświetla listę nauczonych słówek.
       */
      function displayLearnedWords() {
        const learnedWordList = document.getElementById("learned-word-list");
        learnedWordList.innerHTML = "";
        if (learnedWords.length === 0) {
          learnedWordList.innerHTML =
            '<tr><td colspan="4" class="text-center text-gray-500 py-4">Brak słówek w sekcji "Znam już".</td></tr>';
          return;
        }

        learnedWords.forEach((word, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td><input type="checkbox" class="custom-checkbox" data-index="${index}"></td>
                    <td>${word.original}</td>
                    <td>${word.translation}</td>
                    <td><button class="mark-unknown-button custom-icon-button" data-index="${index}"><img src="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/arrow-left-circle.svg" class="custom-icon" /></button></td>
                `;
          learnedWordList.appendChild(row);
        });

        // Obsługa zdarzeń dla przycisków
        document.querySelectorAll(".mark-unknown-button").forEach((button) => {
          button.addEventListener("click", () =>
            markWordAsUnknown(parseInt(button.dataset.index))
          );
        });
      }

      /**
       * Usuwa zaznaczone słówka z listy "Znam już".
       */
      function removeSelectedLearnedWords() {
        const checkboxes = document.querySelectorAll(
          "#learned-word-list .custom-checkbox"
        );
        let wordsToRemove = [];
        checkboxes.forEach((checkbox) => {
          if (checkbox.checked) {
            const index = parseInt(checkbox.dataset.index);
            wordsToRemove.push(index);
          }
        });

        // Sortuj indeksy malejąco, aby usuwać elementy od końca
        wordsToRemove.sort((a, b) => b - a);
        wordsToRemove.forEach((index) => {
          learnedWords.splice(index, 1);
        });
        displayLearnedWords();
      }

      /**
       * Przenosi słówko z listy "Znam już" do "Słowniczka".
       */
      function markWordAsUnknown(index) {
        const word = learnedWords[index];
        word.learned = false;
        words.push(word); // Dodaj z powrotem do głównej listy słówek
        learnedWords.splice(index, 1); // Usuń z "Znam już"
        displayLearnedWords();
        displayWords();
      }

      /**
       * Miesza kolejność słówek w aktualnej liście do nauki.
       */
      function shuffleWords() {
        if (selectedWordsForLearning.length > 0) {
          // Algorytm Tasowania Fishera-Yatesa
          for (let i = selectedWordsForLearning.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [selectedWordsForLearning[i], selectedWordsForLearning[j]] = [
              selectedWordsForLearning[j],
              selectedWordsForLearning[i],
            ];
          }
          currentFlashcardIndex = 0; // Reset index po tasowaniu
          displayFlashcard();
        }
      }

      /**
       * Rozpoczyna test.
       */
      function startTest() {
        const testContainer = document.getElementById("test-container");
        const testResultsContainer = document.getElementById(
          "test-results-container"
        );
        testContainer.style.display = "block";
        testResultsContainer.style.display = "none";
        testQuestions = [];
        currentTestQuestionIndex = 0;
        correctAnswers = 0;
        currentTestType = document.getElementById("test-type").value;
        currentTestScope = document.getElementById("test-scope").value;
        currentTestTranslationDirection = document.getElementById(
          "test-translation-direction"
        ).value;

        if (currentTestScope === "all") {
          testQuestions = selectedWordsForLearning;
        } else if (currentTestScope === "learned") {
          testQuestions = learnedWords;
        } else if (currentTestScope === "random") {
          if (selectedWordsForLearning.length <= 10) {
            testQuestions = [...selectedWordsForLearning];
          } else {
            const shuffledWords = [...selectedWordsForLearning].sort(
              () => 0.5 - Math.random()
            );
            testQuestions = shuffledWords.slice(0, 10);
          }
        }

        if (testQuestions.length === 0) {
          document.getElementById("test-question").textContent =
            "Brak słówek do testowania w wybranym zakresie.";
          document.getElementById("submit-test-answer-button").style.display =
            "none";
          return;
        } else {
          document.getElementById("submit-test-answer-button").style.display =
            "inline-block";
        }

        if (currentTestType === "text-input") {
          document.getElementById("test-input-container").style.display =
            "block";
          document.getElementById("test-options-container").style.display =
            "none";
        } else {
          document.getElementById("test-input-container").style.display =
            "none";
          document.getElementById("test-options-container").style.display =
            "grid";
        }
        loadTestQuestion();
      }

      /**
       * Generuje i wyświetla pytanie testowe.
       */
      function loadTestQuestion() {
        const questionElement = document.getElementById("test-question");
        const answerInput = document.getElementById("test-answer-input");
        const optionButtons = [
          document.getElementById("test-option-1"),
          document.getElementById("test-option-2"),
          document.getElementById("test-option-3"),
          document.getElementById("test-option-4"),
        ];
        answerInput.value = ""; // Wyczyść input
        optionButtons.forEach((button) => {
          button.textContent = ""; // Wyczyść opcje
          button.disabled = false;
        });

        if (testQuestions.length === 0) {
          questionElement.textContent = "Brak dostępnych pytań testowych.";
          return;
        }
        if (currentTestQuestionIndex >= testQuestions.length) {
          displayTestResults();
          return;
        }

        const currentQuestion = testQuestions[currentTestQuestionIndex];
        let questionText, correctAnswer;

        if (currentTestTranslationDirection === "translated-to-original") {
          questionText = `Podaj tłumaczenie słowa: "${currentQuestion.translation}"`;
          correctAnswer = currentQuestion.original;
        } else {
          questionText = `Podaj tłumaczenie słowa: "${currentQuestion.original}"`;
          correctAnswer = currentQuestion.translation;
        }
        questionElement.textContent = questionText;
        questionElement.dataset.correctAnswer = correctAnswer; // Store the correct answer

        if (currentTestType === "multiple-choice") {
          const wrongOptions = [];
          while (wrongOptions.length < 3) {
            const randomIndex = Math.floor(
              Math.random() * testQuestions.length
            );
            const randomWord = testQuestions[randomIndex];
            if (
              randomIndex !== currentTestQuestionIndex &&
              !wrongOptions.includes(randomWord)
            ) {
              wrongOptions.push(randomWord);
            }
          }

          const options = [
            correctAnswer,
            ...wrongOptions.map((word) =>
              currentTestTranslationDirection === "translated-to-original"
                ? word.original
                : word.translation
            ),
          ];
          // Shuffle the options
          options.sort(() => Math.random() - 0.5);

          optionButtons.forEach((button, i) => {
            if (i < options.length) {
              button.textContent = options[i];
              button.dataset.option = options[i]; // Store the option text
              button.onclick = () => {
                checkTestAnswer(options[i]); // Pass selected option to checkTestAnswer
              };
            } else {
              button.style.display = "none";
            }
          });
        }
      }

      /**
       * Sprawdza odpowiedź na pytanie testowe.
       */
      function checkTestAnswer(selectedAnswer = null) {
        // Add parameter for selected answer
        const questionElement = document.getElementById("test-question");
        const userAnswerInput = document.getElementById("test-answer-input");
        const feedbackElement = document.getElementById("test-feedback");
        const correctAnswer = questionElement.dataset.correctAnswer;
        let userAnswer;

        if (currentTestType === "text-input") {
          userAnswer = userAnswerInput.value.trim();
        } else {
          userAnswer = selectedAnswer; // Get selected answer from button
        }

        if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
          feedbackElement.textContent = "Poprawnie!";
          feedbackElement.style.color = "green";
          correctAnswers++;
        } else {
          feedbackElement.textContent = `Niepoprawnie. Prawidłowa odpowiedź to: ${correctAnswer}`;
          feedbackElement.style.color = "red";
        }

        currentTestQuestionIndex++;
        if (currentTestQuestionIndex < testQuestions.length) {
          loadTestQuestion();
        } else {
          displayTestResults();
        }
      }

      /**
       * Wyświetla wyniki testu.
       */
      function displayTestResults() {
        const testContainer = document.getElementById("test-container");
        const testResultsContainer = document.getElementById(
          "test-results-container"
        );
        const resultsText = document.getElementById("test-results-text");
        testContainer.style.display = "none";
        testResultsContainer.style.display = "block";

        const percentage =
          testQuestions.length > 0
            ? (correctAnswers / testQuestions.length) * 100
            : 0;
        resultsText.textContent = `Poprawne odpowiedzi: ${correctAnswers} z ${
          testQuestions.length
        }. Procent poprawnych odpowiedzi: ${percentage.toFixed(2)}%`;
      }

      /**
       * Resetuje test i wraca do ekranu wyboru opcji testu.
       */
      function restartTest() {
        const testContainer = document.getElementById("test-container");
        const testResultsContainer = document.getElementById(
          "test-results-container"
        );
        testContainer.style.display = "none";
        testResultsContainer.style.display = "none";
        currentTestQuestionIndex = 0;
        correctAnswers = 0;
        testQuestions = [];
      }

      // Początkowe załadowanie danych
      if (localStorage.getItem("words")) {
        words = JSON.parse(localStorage.getItem("words"));
      }
      if (localStorage.getItem("learnedWords")) {
        learnedWords = JSON.parse(localStorage.getItem("learnedWords"));
      }

      displayWords();
      displayLearnedWords();
      displayFlashcard(); // Wyświetl pierwszą fiszkę po załadowaniu strony

      // Obsługa zdarzeń
      document
        .getElementById("add-word-button")
        .addEventListener("click", addWord);
      document
        .getElementById("import-csv-button")
        .addEventListener("click", () =>
          document.getElementById("csv-file-input").click()
        );
      document
        .getElementById("csv-file-input")
        .addEventListener("change", (event) => {
          if (event.target.files && event.target.files[0]) {
            importCsv(event.target.files[0]);
          }
        });
      document
        .getElementById("add-to-learn-selected-button")
        .addEventListener("click", addSelectedWordsToLearn);
      document
        .getElementById("previous-button")
        .addEventListener("click", showPreviousFlashcard);
      document
        .getElementById("next-button")
        .addEventListener("click", showNextFlashcard);
      document
        .getElementById("mark-learned-button")
        .addEventListener("click", markWordAsLearned);
      document
        .getElementById("remove-learned-selected-button")
        .addEventListener("click", removeSelectedLearnedWords);
      document
        .getElementById("shuffle-button")
        .addEventListener("click", shuffleWords);
      document
        .getElementById("start-test-button")
        .addEventListener("click", startTest);
      document
        .getElementById("submit-test-answer-button")
        .addEventListener("click", checkTestAnswer);
      document
        .getElementById("restart-test-button")
        .addEventListener("click", restartTest);

      // Local Storage
      window.addEventListener("beforeunload", () => {
        localStorage.setItem("words", JSON.stringify(words));
        localStorage.setItem("learnedWords", JSON.stringify(learnedWords));
      });
    </script>
  </body>
</html>
